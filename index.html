<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Swatcher</title>
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #e8e8e8;
      color: #333;
      height: 100vh;
      overflow: hidden;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    #header {
      background: #fff;
      padding: 10px 20px;
      border-bottom: 1px solid #ddd;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      z-index: 10;
    }

    #header h1 {
      font-size: 18px;
      font-weight: 600;
      color: #1e39d2;
    }

    /* Main three-column layout */
    #main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Left Panel */
    #left-panel {
      width: 280px;
      min-width: 280px;
      background: #fff;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    #tab-bar {
      display: flex;
      border-bottom: 2px solid #eee;
      background: #fafafa;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 8px;
      border: none;
      background: transparent;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: color 0.2s, border-color 0.2s;
    }

    .tab-btn:hover {
      color: #1e39d2;
    }

    .tab-btn.active {
      color: #1e39d2;
      border-bottom-color: #1e39d2;
    }

    #tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    /* Canvas Area */
    #canvas-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f0f0;
      padding: 20px;
      position: relative;
    }

    /* Right Panel */
    #right-panel {
      width: 80px;
      min-width: 80px;
      background: #fff;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 8px;
      gap: 8px;
    }

    /* Bottom Toolbar */
    #bottom-toolbar {
      background: #fff;
      padding: 12px 20px;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: center;
      gap: 12px;
      box-shadow: 0 -1px 3px rgba(0,0,0,0.1);
    }
    /* Buttons */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-primary {
      background: #1e39d2;
      color: #fff;
    }

    .btn-primary:hover {
      background: #1630b0;
    }

    .btn-secondary {
      background: #6c757d;
      color: #fff;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    /* Section titles */
    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #333;
    }

    .section-subtitle {
      font-size: 12px;
      font-weight: 600;
      margin: 12px 0 8px;
      color: #666;
    }

    /* Upload dropzone */
    .dropzone {
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 24px;
      text-align: center;
      color: #999;
      font-size: 13px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }

    .dropzone.drag-over {
      border-color: #1e39d2;
      background: #f0f3ff;
    }

    .dropzone p {
      margin-bottom: 4px;
    }

    .dropzone-sub {
      font-size: 11px;
      margin: 8px 0 !important;
    }

    .upload-label {
      display: inline-block;
      margin-top: 8px;
    }

    /* Upload mode radios */
    .upload-mode {
      margin-top: 12px;
      display: flex;
      gap: 16px;
    }

    .radio-label {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      color: #555;
    }

    /* Overlay gallery */
    .overlay-gallery {
      margin-top: 16px;
    }

    .thumb-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .thumb-grid img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border: 2px solid #eee;
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .thumb-grid img:hover {
      border-color: #1e39d2;
    }
  </style>
</head>
<body>
  <div id="app">
    <header id="header">
      <h1>Product Swatcher</h1>
    </header>
    <div id="main">
      <aside id="left-panel">
        <div id="tab-bar">
          <button class="tab-btn active" data-tab="upload">Upload</button>
          <button class="tab-btn" data-tab="text">Add Text</button>
          <button class="tab-btn" data-tab="details">Product Details</button>
        </div>
        <div id="tab-content">
          <div id="tab-upload" class="tab-pane active">
            <div class="upload-section">
              <h3 class="section-title">Upload Image</h3>

              <div id="upload-dropzone" class="dropzone">
                <p>Drag & drop image here</p>
                <p class="dropzone-sub">or</p>
                <label class="btn btn-primary upload-label">
                  Browse Files
                  <input type="file" id="file-input" accept="image/*" hidden>
                </label>
              </div>

              <div class="upload-mode">
                <label class="radio-label">
                  <input type="radio" name="upload-mode" value="overlay" checked>
                  Add as Overlay
                </label>
                <label class="radio-label">
                  <input type="radio" name="upload-mode" value="background">
                  Set as Background
                </label>
              </div>

              <div id="overlay-gallery" class="overlay-gallery">
                <h4 class="section-subtitle">Uploaded Overlays</h4>
                <div id="overlay-thumbs" class="thumb-grid"></div>
              </div>
            </div>
          </div>
          <div id="tab-text" class="tab-pane"></div>
          <div id="tab-details" class="tab-pane"></div>
        </div>
      </aside>
      <main id="canvas-area">
        <canvas id="product-canvas"></canvas>
      </main>
      <aside id="right-panel"></aside>
    </div>
    <footer id="bottom-toolbar"></footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
  <script>
    // ===== APP STATE =====
    const state = {
      canvas: null,
      backgroundImage: null,
      tintOverlay: null,
      tintColor: null,
      quillEditor: null,
      zoomLevel: 1,
      uploadedOverlays: [],
    };

    // ===== CANVAS SETUP =====
    function initCanvas() {
      const area = document.getElementById('canvas-area');
      const width = Math.min(area.clientWidth - 40, 600);
      const height = Math.min(area.clientHeight - 40, 500);

      state.canvas = new fabric.Canvas('product-canvas', {
        width: width,
        height: height,
        backgroundColor: '#ffffff',
        selection: true,
        preserveObjectStacking: true,
      });

      loadDefaultBackground();
    }

    function loadDefaultBackground() {
      const canvas = state.canvas;
      const defaultBg = new fabric.Rect({
        width: canvas.width,
        height: canvas.height,
        fill: '#e0e0e0',
        selectable: false,
        evented: false,
      });

      const placeholderText = new fabric.Text('Upload a Product Image', {
        fontSize: 20,
        fill: '#999',
        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
        selectable: false,
        evented: false,
      });

      placeholderText.set({
        left: (canvas.width - placeholderText.width) / 2,
        top: (canvas.height - placeholderText.height) / 2,
      });

      const bgGroup = new fabric.Group([defaultBg, placeholderText], {
        selectable: false,
        evented: false,
        name: 'defaultBackground',
      });

      state.backgroundImage = bgGroup;
      canvas.insertAt(bgGroup, 0);
      canvas.renderAll();
    }

    function setBackgroundImage(dataUrl) {
      const canvas = state.canvas;

      fabric.Image.fromURL(dataUrl, function(img) {
        if (state.backgroundImage) {
          canvas.remove(state.backgroundImage);
        }

        const scaleX = canvas.width / img.width;
        const scaleY = canvas.height / img.height;
        const scale = Math.min(scaleX, scaleY);

        img.set({
          scaleX: scale,
          scaleY: scale,
          left: (canvas.width - img.width * scale) / 2,
          top: (canvas.height - img.height * scale) / 2,
          selectable: false,
          evented: false,
          name: 'backgroundImage',
        });

        state.backgroundImage = img;
        canvas.insertAt(img, 0);

        if (state.tintOverlay) {
          canvas.remove(state.tintOverlay);
          canvas.insertAt(state.tintOverlay, 1);
        }

        canvas.renderAll();
      });
    }

    // ===== TAB SWITCHING =====
    function initTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabPanes = document.querySelectorAll('.tab-pane');

      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          tabBtns.forEach(b => b.classList.remove('active'));
          tabPanes.forEach(p => p.classList.remove('active'));

          btn.classList.add('active');
          const tabId = 'tab-' + btn.dataset.tab;
          document.getElementById(tabId).classList.add('active');
        });
      });
    }

    // ===== UPLOAD FUNCTIONALITY =====
    function initUpload() {
      const dropzone = document.getElementById('upload-dropzone');
      const fileInput = document.getElementById('file-input');

      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('drag-over');
      });

      dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('drag-over');
      });

      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('drag-over');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
          handleImageUpload(file);
        }
      });

      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          handleImageUpload(file);
        }
        fileInput.value = '';
      });

      dropzone.addEventListener('click', (e) => {
        if (e.target.tagName !== 'INPUT') {
          fileInput.click();
        }
      });
    }

    function handleImageUpload(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const dataUrl = e.target.result;
        const mode = document.querySelector('input[name="upload-mode"]:checked').value;

        if (mode === 'background') {
          setBackgroundImage(dataUrl);
        } else {
          addOverlayImage(dataUrl);
          addOverlayThumbnail(dataUrl);
        }
      };
      reader.readAsDataURL(file);
    }

    function addOverlayImage(dataUrl) {
      const canvas = state.canvas;

      fabric.Image.fromURL(dataUrl, function(img) {
        const maxW = canvas.width * 0.4;
        const maxH = canvas.height * 0.4;
        const scale = Math.min(maxW / img.width, maxH / img.height, 1);

        img.set({
          scaleX: scale,
          scaleY: scale,
          left: canvas.width / 2,
          top: canvas.height / 2,
          originX: 'center',
          originY: 'center',
          name: 'overlay',
        });

        canvas.add(img);
        canvas.setActiveObject(img);
        canvas.renderAll();
      });
    }

    function addOverlayThumbnail(dataUrl) {
      state.uploadedOverlays.push(dataUrl);
      const thumbsContainer = document.getElementById('overlay-thumbs');
      const thumb = document.createElement('img');
      thumb.src = dataUrl;
      thumb.title = 'Click to add again';
      thumb.addEventListener('click', () => addOverlayImage(dataUrl));
      thumbsContainer.appendChild(thumb);
    }

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', () => {
      initCanvas();
      initTabs();
      initUpload();
    });
  </script>
</body>
</html>
